<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#156082">
    <title>Summary - Learning Maths in Baby Steps</title>
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <link rel="stylesheet" href="shared.css">
    <link rel="stylesheet" href="summary.css">
    <script src="shared.js"></script>
    <script src="shared_db.js"></script>
    <script src="summary.js"></script>
    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</head>
<body>
    <div class="container">
        <!-- Assignment Summary -->
        <div id="summarySection" class="summary-section">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Learning Maths in Baby Steps</h1>
                <div class="user-info-bar">
                    <span id="summaryUserNameDisplay">Name: </span>
                    <span id="summaryUserClassDisplay">Class: </span>
                    <span id="summaryUserRollDisplay">Roll Number: </span>
                </div>
                <div class="dashboard-buttons-grid">
                    <button class="btn btn-auth" onclick="window.location.href = 'student-dashboard.html'">Dashboard</button>
                </div>
            </div>
            
            <h2>Session Summary</h2>
            <div class="summary-stats" id="summaryStats"></div>
            <div class="pass-fail" id="passFail"></div>
            <div class="question-details" id="questionDetails"></div>
        </div>
    </div>

    <script>
        // Initialize state
        let selectedOperation = null;
        
        const learningSequence = {
            addition: ['1A0', '1A1', '1A2', '1A3', '1A', '1B', '1C', '1D', '1', '1M1', '1M2'],
            subtraction: ['2A', '2B', '2C', '2D', '2', '2M1', '2M2', '2M3'],
            multiplication: ['3A0', '3A1', '3A2S', '3A2', '3A3S', '3A3', '3A', '3B4S', '3B4', '3B5S', '3B5', '3B6S', '3B6', '3B', '3C7S', '3C7', '3C8S', '3C8', '3C9S', '3C9', '3C', '3', '3M1', '3M2'],
            division: ['4A1', '4A2', '4A3', '4A', '4B4', '4B5', '4B6', '4B', '4C7', '4C8', '4C9', '4C', '4', '4M1', '4M2']
        };
        window.learningSequence = learningSequence;
        window.selectedOperation = selectedOperation;

        function updateSummaryPageHeader() {
            if (currentUserProfile) {
                const fullName = [currentUserProfile.first_name, currentUserProfile.last_name].filter(Boolean).join(' ');
                const classSection = currentUserProfile.class && currentUserProfile.section 
                    ? `${currentUserProfile.class}${currentUserProfile.section}` 
                    : '';
                const rollNumber = currentUserProfile.roll_number || '';
                
                document.getElementById('summaryUserNameDisplay').textContent = fullName ? `Name: ${fullName}` : '';
                document.getElementById('summaryUserClassDisplay').textContent = classSection ? `Class: ${classSection}` : '';
                document.getElementById('summaryUserRollDisplay').textContent = rollNumber ? `Roll Number: ${rollNumber}` : '';
            }
        }


        window.addEventListener('DOMContentLoaded', () => {
            // Initialize Supabase
            function tryInitSupabase(attempts = 0) {
                if (window.supabase && window.supabase.createClient) {
                    initSupabase();
                } else if (attempts < 5) {
                    setTimeout(() => tryInitSupabase(attempts + 1), 1000);
                } else {
                    console.error('‚ùå Supabase library failed to load');
                }
            }
            
            tryInitSupabase();

            // Get session data from sessionStorage
            const sessionData = sessionStorage.getItem('quizSessionData');
            if (sessionData) {
                try {
                    const session = JSON.parse(sessionData);
                    // Restore session - convert askedQuestions array back to Set
                    if (session.askedQuestions && Array.isArray(session.askedQuestions)) {
                        session.askedQuestions = new Set(session.askedQuestions);
                    }
                    // Restore session to global currentSession
                    window.currentSession = session;
                    // Show summary
                    setTimeout(() => {
                        updateSummaryPageHeader();
                        if (typeof showSummary === 'function') {
                            showSummary();
                        }
                        
                        // Save score if user is logged in
                        if (currentUser && session && session.operation && session.variant) {
                            const totalQuestions = (session.correctCount || 0) + (session.wrongCount || 0);
                            const score = totalQuestions > 0 ? Math.round(((session.correctCount || 0) / totalQuestions) * 100) : 0;
                            const variantKey = `${session.operation}_${session.variant}`;
                            const passed = session.passed || false;
                            
                            console.log('üîÑ Saving score:', { variantKey, score, passed });
                            
                            // Save score with correct parameters (including passed value)
                            if (typeof saveScore === 'function') {
                                saveScore(variantKey, score, passed).then(savedData => {
                                    if (savedData) {
                                        console.log('‚úÖ Score saved to server');
                                        // Dashboard will fetch fresh data when user navigates to it
                                    } else {
                                        console.error('‚ùå Failed to save score');
                                    }
                                }).catch(err => {
                                    console.warn('‚ö†Ô∏è Error saving score:', err);
                                });
                            }
                        }
                        
                        // Clear session data after displaying
                        sessionStorage.removeItem('quizSessionData');
                    }, 500);
                } catch (e) {
                    console.error('Error restoring session:', e);
                    window.location.href = 'student-dashboard.html';
                }
            } else {
                // No session data, redirect to dashboard
                console.warn('No session data found, redirecting to dashboard');
                window.location.href = 'student-dashboard.html';
            }
        });
    </script>
</body>
</html>
