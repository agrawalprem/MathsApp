<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#156082">
    <title>Learning Maths in Baby Steps</title>
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <link rel="stylesheet" href="shared.css">
    <link rel="stylesheet" href="index.css">
    <script src="shared.js"></script>
    <script src="shared_db.js"></script>
    <script src="index.js"></script>
    <script>
        // Device and browser detection for compatibility
        window.deviceInfo = {
            userAgent: navigator.userAgent,
            isAndroid: /Android/i.test(navigator.userAgent),
            isOldAndroid: /Android [0-6]\./i.test(navigator.userAgent) || /Android [0-9]\.[0-4]/i.test(navigator.userAgent),
            chromeVersion: (navigator.userAgent.match(/Chrome\/(\d+)/) || [])[1] || 'unknown',
            webViewVersion: (navigator.userAgent.match(/wv\)\.Chrome\/(\d+)/) || [])[1] || 'unknown'
        };
        console.log('ðŸ“± Device Info:', window.deviceInfo);
        
        // Display JavaScript errors on screen for mobile debugging
        window.addEventListener('error', (e) => {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#dc3545;color:white;padding:15px;z-index:99999;font-size:12px;font-family:monospace;';
            errorDiv.textContent = `ERROR: ${e.message} at ${e.filename}:${e.lineno}`;
            document.body.appendChild(errorDiv);
            console.error('JavaScript Error:', e);
        });
        
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration.scope);
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            console.log('Service Worker update found');
                        });
                    })
                    .catch((error) => {
                        console.error('Service Worker registration failed:', error);
                    });
            });
        }

        // Diagnostic function to check PWA installability
        window.checkPWAInstallability = async function() {
            console.log('=== PWA Installability Check ===');
            
            // Check manifest
            try {
                const manifestResponse = await fetch('/manifest.json');
                const manifest = await manifestResponse.json();
                console.log('âœ“ Manifest found:', manifest);
                
                // Check icons
                for (const icon of manifest.icons || []) {
                    try {
                        const iconResponse = await fetch(icon.src);
                        if (iconResponse.ok) {
                            console.log(`âœ“ Icon accessible: ${icon.src} (${icon.sizes})`);
                        } else {
                            console.error(`âœ— Icon not accessible: ${icon.src} - Status: ${iconResponse.status}`);
                        }
                    } catch (error) {
                        console.error(`âœ— Icon error: ${icon.src}`, error);
                    }
                }
            } catch (error) {
                console.error('âœ— Manifest error:', error);
            }
            
            // Check service worker
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.ready;
                    console.log('âœ“ Service Worker ready:', registration.scope);
                    console.log('âœ“ Service Worker active:', registration.active ? 'Yes' : 'No');
                } catch (error) {
                    console.error('âœ— Service Worker not ready:', error);
                }
            } else {
                console.error('âœ— Service Workers not supported');
            }
            
            // Check HTTPS
            console.log('âœ“ HTTPS:', window.location.protocol === 'https:' ? 'Yes' : 'No');
            
            // Check if install prompt is available
            let deferredPrompt = null;
            window.addEventListener('beforeinstallprompt', (e) => {
                deferredPrompt = e;
                console.log('âœ“ beforeinstallprompt event fired!');
                console.log('You can now call: window.triggerInstall()');
            });
            
            window.triggerInstall = async function() {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log('User choice:', outcome);
                    deferredPrompt = null;
                } else {
                    console.log('Install prompt not available. Try refreshing the page.');
                }
            };
            
            console.log('=== End Check ===');
        };
    </script>
</head>
<body>
    <div class="container">
        <!-- Registration Page -->
        <div id="registrationPage" class="registration-page">
            <h1 class="page-title">Learning Maths in Baby Steps</h1>
            
            <div class="auth-buttons-grid">
                <button class="btn btn-auth" onclick="toggleWelcome()">Welcome</button>
                <button class="btn btn-auth" onclick="showAnonymousUser()">Anonymous User</button>
                <button class="btn btn-auth" onclick="showRegistration()">Registration</button>
                <div class="auth-combined">
                    <button class="btn btn-auth" onclick="showLogin()" id="loginBtnTop">Login</button>
                    <button class="btn btn-auth hidden" onclick="handleLogout()" id="logoutBtnTop">Logout</button>
                </div>
                <button class="btn btn-auth" onclick="showForgotPassword()">Forgot Password</button>
            </div>
            
            <!-- Teaching Method Information -->
            <div class="teaching-method-info hidden" id="welcomeContent">
                <div class="welcome-text">
                    <p>Welcome to this new method of teaching children the fundamentals of arithmetic. The object of this method is to make children fluent in</p>
                </div>
                
                <div class="operations-row">
                    <div class="operation-box">Single-digit Addition</div>
                    <div class="operation-box">Single-digit Subtraction</div>
                    <div class="operation-box">Single-digit Multiplication</div>
                    <div class="operation-box">Single-digit Division</div>
                </div>
                
                <div class="pedagogical-text">
                    <p>The emphasis is on practice and perfection. Both speed and accuracy are important. Each child learns at her own pace and the progress of each child is tracked. Apart from single digit operations, children also learn the art of mental calculation in</p>
                </div>
                
                <div class="operations-row">
                    <div class="operation-box">Multi-digit Addition</div>
                    <div class="operation-box">Multi-digit Subtraction</div>
                    <div class="operation-box">Multi-digit Multiplication by 1-digit</div>
                    <div class="operation-box">Multi-digit<br>Division<br>by 1-digit</div>
                </div>
                
                <div class="techniques-list">
                    <ul>
                        <li>Multi-digit Addition and multiplication are done without writing carry.</li>
                        <li>Multi-digit subtraction is done without writing borrowing.</li>
                        <li>Multi-digit division is done without writing remainder.</li>
                    </ul>
                </div>
                
                <div class="progression-arrow">
                    <div class="math-box math-box-left">I hate Maths</div>
                    <div class="arrow-container">
                        <svg width="60" height="40" viewBox="0 0 60 40" xmlns="http://www.w3.org/2000/svg">
                            <path d="M 5 15 L 45 15 L 45 8 L 55 20 L 45 32 L 45 25 L 5 25 Z" fill="#156082"/>
                        </svg>
                    </div>
                    <div class="math-box math-box-right">I love Maths</div>
                </div>
                
                <div class="contact-info">
                    <span class="contact-name">Prem Agrawal</span>
                    <a href="mailto:agrawal.prem@gmail.com" class="contact-email">agrawal.prem@gmail.com</a>
                    <span class="contact-phone">+91 9822847682</span>
                </div>
            </div>
            
            <div id="authContentArea" class="auth-content-area">
                <!-- Content will be dynamically inserted here -->
            </div>
        </div>
    </div>
</body>
</html>
