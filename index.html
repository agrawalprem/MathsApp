<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#156082">
    <title>Learning Maths in Baby Steps</title>
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <link rel="stylesheet" href="shared.css">
    <link rel="stylesheet" href="index.css">
    <!-- CRITICAL: Debug display must load FIRST to catch all errors -->
    <script>
        // Initialize IMMEDIATELY - before any other scripts
        window.debugErrors = [];
        window.swVersion = 'v1.0.31 (Checking...)';
        
        // Create debug display container as early as possible
        (function() {
            function createDebugDisplayNow() {
                try {
                    if (!document.body) {
                        setTimeout(createDebugDisplayNow, 10);
                        return;
                    }
                    if (document.getElementById('mobileDebugDisplay')) {
                        return;
                    }
                    const debugDiv = document.createElement('div');
                    debugDiv.id = 'mobileDebugDisplay';
                    debugDiv.style.cssText = 'position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,0.95);color:#fff;padding:10px;font-size:11px;z-index:99999;max-height:250px;overflow-y:auto;font-family:monospace;border-top:3px solid #ff4444;';
                    debugDiv.innerHTML = '<div style="font-weight:bold;margin-bottom:8px;color:#ffaa00;font-size:13px;">üêõ Mobile Debug Info</div><div id="debugContent">Initializing...</div>';
                    document.body.appendChild(debugDiv);
                    console.log('‚úÖ Debug display created');
                } catch (e) {
                    console.error('‚ùå Failed to create debug display:', e);
                }
            }
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', createDebugDisplayNow);
            } else {
                createDebugDisplayNow();
            }
            setTimeout(createDebugDisplayNow, 100);
        })();
        
        // Set up error handlers BEFORE other scripts
        window.addEventListener('error', function(e) {
            try {
                const errorInfo = {
                    message: e.message,
                    filename: e.filename ? e.filename.split('/').pop() : 'unknown',
                    lineno: e.lineno,
                    colno: e.colno
                };
                window.debugErrors.push(errorInfo);
                if (window.debugErrors.length > 10) {
                    window.debugErrors.shift();
                }
                if (window.updateDebugDisplay) {
                    window.updateDebugDisplay();
                }
                if (e.message.includes('not defined') || e.message.includes('undefined') || e.message.includes('is not a function')) {
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = 'position:fixed;top:10px;left:10px;right:10px;background:#ff4444;color:#fff;padding:12px;border-radius:5px;z-index:99998;font-size:13px;box-shadow:0 4px 8px rgba(0,0,0,0.4);font-weight:bold;';
                    errorDiv.innerHTML = '‚ö†Ô∏è <strong>ERROR:</strong> ' + e.message + '<br><small style="font-weight:normal;opacity:0.9;">' + errorInfo.filename + ':' + e.lineno + '</small>';
                    document.body.appendChild(errorDiv);
                    setTimeout(function() { errorDiv.remove(); }, 15000);
                }
            } catch (err) {
                console.error('Error handler failed:', err);
            }
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            try {
                window.debugErrors.push({
                    message: 'Promise Rejection: ' + (e.reason && e.reason.message ? e.reason.message : e.reason || 'Unknown'),
                    filename: 'Promise',
                    lineno: 0
                });
                if (window.debugErrors.length > 10) {
                    window.debugErrors.shift();
                }
                if (window.updateDebugDisplay) {
                    window.updateDebugDisplay();
                }
            } catch (err) {
                console.error('Promise rejection handler failed:', err);
            }
        });
    </script>
    <script>
        // Initialize debug display IMMEDIATELY - before any other scripts
        (function() {
            // Create debug display as soon as possible
            function createDebugDisplayNow() {
                try {
                    // Wait for body if needed
                    if (!document.body) {
                        setTimeout(createDebugDisplayNow, 10);
                        return;
                    }
                    
                    // Check if already exists
                    if (document.getElementById('mobileDebugDisplay')) {
                        return;
                    }
                    
                    const debugDiv = document.createElement('div');
                    debugDiv.id = 'mobileDebugDisplay';
                    debugDiv.style.cssText = 'position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,0.95);color:#fff;padding:10px;font-size:11px;z-index:99999;max-height:250px;overflow-y:auto;font-family:monospace;border-top:3px solid #ff4444;';
                    debugDiv.innerHTML = '<div style="font-weight:bold;margin-bottom:8px;color:#ffaa00;font-size:13px;">üêõ Mobile Debug Info</div><div id="debugContent">Loading...</div>';
                    document.body.appendChild(debugDiv);
                    
                    // Initialize error tracking
                    window.debugErrors = window.debugErrors || [];
                    window.swVersion = window.swVersion || 'v1.0.29 (Checking...)';
                    
                    console.log('‚úÖ Debug display created');
                } catch (e) {
                    console.error('‚ùå Failed to create debug display:', e);
                }
            }
            
            // Try to create immediately
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', createDebugDisplayNow);
            } else {
                createDebugDisplayNow();
            }
            
            // Also try after a short delay as fallback
            setTimeout(createDebugDisplayNow, 100);
        })();
    </script>
    
    <script src="shared.js"></script>
    <script src="shared_db.js"></script>
    <script src="index.js" onerror="window.indexJsLoadError = 'Failed to load index.js'; if(window.updateDebugDisplay) window.updateDebugDisplay();"></script>
    <script>
        // Check if index.js loaded after a delay
        setTimeout(function() {
            if (typeof window.showLogin !== 'function') {
                window.indexJsLoadError = window.indexJsLoadError || 'index.js loaded but functions not defined';
                if (window.updateDebugDisplay) window.updateDebugDisplay();
            }
        }, 2000);
    </script>
    <script>
        // Register Service Worker (version tracking in debug display below)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration.scope);
                        // Update version display
                        if (registration.active) {
                            window.swVersion = 'v1.0.31 (Active)';
                        } else if (registration.installing) {
                            window.swVersion = 'v1.0.31 (Installing)';
                        } else if (registration.waiting) {
                            window.swVersion = 'v1.0.31 (Waiting)';
                        }
                        if (window.updateDebugDisplay) window.updateDebugDisplay();
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            console.log('Service Worker update found');
                            window.swVersion = 'v1.0.31 (Updating)';
                            if (window.updateDebugDisplay) window.updateDebugDisplay();
                        });
                    })
                    .catch((error) => {
                        console.error('Service Worker registration failed:', error);
                        window.swVersion = 'Failed: ' + error.message;
                        if (window.updateDebugDisplay) window.updateDebugDisplay();
                    });
            });
        }

        // Diagnostic function to check PWA installability
        window.checkPWAInstallability = async function() {
            console.log('=== PWA Installability Check ===');
            
            // Check manifest
            try {
                const manifestResponse = await fetch('/manifest.json');
                const manifest = await manifestResponse.json();
                console.log('‚úì Manifest found:', manifest);
                
                // Check icons
                for (const icon of manifest.icons || []) {
                    try {
                        const iconResponse = await fetch(icon.src);
                        if (iconResponse.ok) {
                            console.log(`‚úì Icon accessible: ${icon.src} (${icon.sizes})`);
                        } else {
                            console.error(`‚úó Icon not accessible: ${icon.src} - Status: ${iconResponse.status}`);
                        }
                    } catch (error) {
                        console.error(`‚úó Icon error: ${icon.src}`, error);
                    }
                }
            } catch (error) {
                console.error('‚úó Manifest error:', error);
            }
            
            // Check service worker
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.ready;
                    console.log('‚úì Service Worker ready:', registration.scope);
                    console.log('‚úì Service Worker active:', registration.active ? 'Yes' : 'No');
                } catch (error) {
                    console.error('‚úó Service Worker not ready:', error);
                }
            } else {
                console.error('‚úó Service Workers not supported');
            }
            
            // Check HTTPS
            console.log('‚úì HTTPS:', window.location.protocol === 'https:' ? 'Yes' : 'No');
            
            // Check if install prompt is available
            let deferredPrompt = null;
            window.addEventListener('beforeinstallprompt', (e) => {
                deferredPrompt = e;
                console.log('‚úì beforeinstallprompt event fired!');
                console.log('You can now call: window.triggerInstall()');
            });
            
            window.triggerInstall = async function() {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log('User choice:', outcome);
                    deferredPrompt = null;
                } else {
                    console.log('Install prompt not available. Try refreshing the page.');
                }
            };
            
            console.log('=== End Check ===');
        };
    </script>
</head>
<body>
    <div class="container">
        <!-- Registration Page -->
        <div id="registrationPage" class="registration-page">
            <h1 class="page-title">Learning Maths in Baby Steps</h1>
            
            <div class="auth-buttons-grid">
                <button class="btn btn-auth" onclick="toggleWelcome()">Welcome</button>
                <button class="btn btn-auth" onclick="showAnonymousUser()">Anonymous User</button>
                <button class="btn btn-auth" onclick="showRegistration()">Registration</button>
                <div class="auth-combined">
                    <button class="btn btn-auth" onclick="showLogin()" id="loginBtnTop">Login</button>
                    <button class="btn btn-auth hidden" onclick="handleLogout()" id="logoutBtnTop">Logout</button>
                </div>
                <button class="btn btn-auth" onclick="showForgotPassword()">Forgot Password</button>
            </div>
            
            <!-- Teaching Method Information -->
            <div class="teaching-method-info hidden" id="welcomeContent">
                <div class="welcome-text">
                    <p>Welcome to this new method of teaching children the fundamentals of arithmetic. The object of this method is to make children fluent in</p>
                </div>
                
                <div class="operations-row">
                    <div class="operation-box">Single-digit Addition</div>
                    <div class="operation-box">Single-digit Subtraction</div>
                    <div class="operation-box">Single-digit Multiplication</div>
                    <div class="operation-box">Single-digit Division</div>
                </div>
                
                <div class="pedagogical-text">
                    <p>The emphasis is on practice and perfection. Both speed and accuracy are important. Each child learns at her own pace and the progress of each child is tracked. Apart from single digit operations, children also learn the art of mental calculation in</p>
                </div>
                
                <div class="operations-row">
                    <div class="operation-box">Multi-digit Addition</div>
                    <div class="operation-box">Multi-digit Subtraction</div>
                    <div class="operation-box">Multi-digit Multiplication by 1-digit</div>
                    <div class="operation-box">Multi-digit<br>Division<br>by 1-digit</div>
                </div>
                
                <div class="techniques-list">
                    <ul>
                        <li>Multi-digit Addition and multiplication are done without writing carry.</li>
                        <li>Multi-digit subtraction is done without writing borrowing.</li>
                        <li>Multi-digit division is done without writing remainder.</li>
                    </ul>
                </div>
                
                <div class="progression-arrow">
                    <div class="math-box math-box-left">I hate Maths</div>
                    <div class="arrow-container">
                        <svg width="60" height="40" viewBox="0 0 60 40" xmlns="http://www.w3.org/2000/svg">
                            <path d="M 5 15 L 45 15 L 45 8 L 55 20 L 45 32 L 45 25 L 5 25 Z" fill="#156082"/>
                        </svg>
                    </div>
                    <div class="math-box math-box-right">I love Maths</div>
                </div>
                
                <div class="contact-info">
                    <span class="contact-name">Prem Agrawal</span>
                    <a href="mailto:agrawal.prem@gmail.com" class="contact-email">agrawal.prem@gmail.com</a>
                    <span class="contact-phone">+91 9822847682</span>
                </div>
            </div>
            
            <div id="authContentArea" class="auth-content-area">
                <!-- Content will be dynamically inserted here -->
            </div>
        </div>
    </div>
    
    <!-- Mobile Debug Display - Update function (display created in head) -->
    <script>
        // Update function for debug display (created in head section)
        window.updateDebugDisplay = function() {
            try {
                const content = document.getElementById('debugContent');
                if (!content) return;
                
                const errors = window.debugErrors || [];
                const errorCount = errors.length;
                
                var html = '<div style="margin-bottom:6px;padding:4px;background:rgba(255,255,255,0.1);border-radius:3px;"><strong>SW Version:</strong> ' + (window.swVersion || 'v1.0.31 (Unknown)') + '</div>';
                html += '<div style="margin-bottom:6px;"><strong>Errors:</strong> <span style="color:' + (errorCount > 0 ? '#ff6666' : '#66ff66') + '">' + errorCount + '</span></div>';
                
                if (errorCount > 0) {
                    html += '<div style="margin-top:8px;color:#ff6666;font-weight:bold;">Recent Errors:</div>';
                    for (var i = 0; i < Math.min(5, errors.length); i++) {
                        var err = errors[errors.length - 1 - i];
                        var msg = (err.message || err).toString().substring(0, 80);
                        html += '<div style="margin-left:10px;margin-top:4px;font-size:10px;padding:3px;background:rgba(255,0,0,0.2);border-left:2px solid #ff6666;">' + (i+1) + '. ' + msg + '</div>';
                    }
                }
                
                // Check function availability
                var functions = ['showLogin', 'showRegistration', 'toggleWelcome', 'showAnonymousUser', 'handleLoginStep1'];
                var missing = [];
                for (var j = 0; j < functions.length; j++) {
                    if (typeof window[functions[j]] !== 'function') {
                        missing.push(functions[j]);
                    }
                }
                if (missing.length > 0) {
                    html += '<div style="margin-top:8px;color:#ffaa00;font-weight:bold;">‚ö†Ô∏è Missing Functions:</div>';
                    html += '<div style="margin-left:10px;color:#ffaa00;font-size:10px;">' + missing.join(', ') + '</div>';
                    if (window.indexJsLoadError) {
                        html += '<div style="margin-top:5px;color:#ff6666;font-size:10px;font-weight:bold;">‚ùå index.js Error: ' + window.indexJsLoadError + '</div>';
                    } else {
                        html += '<div style="margin-top:5px;color:#ffaa00;font-size:10px;">Checking if index.js loaded...</div>';
                    }
                } else {
                    html += '<div style="margin-top:8px;color:#66ff66;">‚úÖ All functions loaded</div>';
                }
                
                // Check if scripts are loaded
                var scripts = document.getElementsByTagName('script');
                var indexJsFound = false;
                for (var k = 0; k < scripts.length; k++) {
                    if (scripts[k].src && scripts[k].src.includes('index.js')) {
                        indexJsFound = true;
                        break;
                    }
                }
                if (!indexJsFound && missing.length > 0) {
                    html += '<div style="margin-top:5px;color:#ff6666;font-size:10px;">‚ö†Ô∏è index.js script tag not found in DOM</div>';
                }
                
                content.innerHTML = html;
            } catch (e) {
                console.error('updateDebugDisplay failed:', e);
            }
        };
        
        // Update display every 2 seconds
        if (window.updateDebugDisplay) {
            setInterval(window.updateDebugDisplay, 2000);
            // Also update immediately
            setTimeout(window.updateDebugDisplay, 500);
        }
    </script>
</body>
</html>
