<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#156082">
    <title>Student Dashboard - Learning Maths in Baby Steps</title>
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <link rel="stylesheet" href="shared.css">
    <link rel="stylesheet" href="student-dashboard.css">
    <script src="shared.js"></script>
    <script src="shared_db.js"></script>
    <script src="student-dashboard.js"></script>
    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
    </script>
</head>
<body>
    <div class="container">
        <!-- Student Dashboard -->
        <div id="studentDashboard" class="student-dashboard">
            <div class="dashboard-header">
                <h1 class="dashboard-title">Learning Maths in Baby Steps</h1>
                <div class="user-info-bar">
                    <span id="userNameDisplay">Name: </span>
                    <span id="userClassDisplay">Class: </span>
                    <span id="userRollDisplay">Roll Number: </span>
                </div>
                <div class="dashboard-buttons-grid">
                    <button id="teacherDashboardBtn" class="btn btn-auth hidden" onclick="window.location.href = 'teacher-dashboard.html'">Teacher Dashboard</button>
                    <button class="btn btn-auth" onclick="handleLogout()">Logout</button>
                </div>
            </div>
            
            <div class="operations-grid">
                <div class="operation-card" onclick="selectOperation('addition')">
                    <div class="operation-symbol">+</div>
                    <div class="operation-name">Addition</div>
                </div>
                <div class="operation-card" onclick="selectOperation('subtraction')">
                    <div class="operation-symbol">−</div>
                    <div class="operation-name">Subtraction</div>
                </div>
                <div class="operation-card" onclick="selectOperation('multiplication')">
                    <div class="operation-symbol">×</div>
                    <div class="operation-name">Multiplication</div>
                </div>
                <div class="operation-card" onclick="selectOperation('division')">
                    <div class="operation-symbol">÷</div>
                    <div class="operation-name">Division</div>
                </div>
            </div>
            
            <div id="variantsContainerAddition" class="variants-container hidden">
                <div class="variant-card" data-operation="addition" data-variant="1A0">
                    <div class="variant-name">1A0: Adding 0</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="addition" data-variant="1A1">
                    <div class="variant-name">1A1: Adding 1</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="addition" data-variant="1A2">
                    <div class="variant-name">1A2: Adding 2</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="addition" data-variant="1A3">
                    <div class="variant-name">1A3: Adding 3</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="addition" data-variant="1A">
                    <div class="variant-name">1A: Adding 0, 1, 2, 3</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="addition" data-variant="1B">
                    <div class="variant-name">1B: Adding Bigger Number to Smaller Number</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="addition" data-variant="1C">
                    <div class="variant-name">1C: Both Numbers Same</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="addition" data-variant="1D">
                    <div class="variant-name">1D: Adding Large Numbers (6-9)</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="addition" data-variant="1">
                    <div class="variant-name">1: Adding Single-digit Numbers (0-9)</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="addition" data-variant="1M1">
                    <div class="variant-name">1M1: Adding Multi-digit Numbers without Carry</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="addition" data-variant="1M2">
                    <div class="variant-name">1M2: Adding Multi-digit Numbers with Carry</div>
                    <div class="variant-status">Not started</div>
                </div>
            </div>
            <div id="variantsContainerSubtraction" class="variants-container hidden">
                <div class="variant-card" data-operation="subtraction" data-variant="2A">
                    <div class="variant-name">2A: Subtracting (0-4), Result (0-4)</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="subtraction" data-variant="2B">
                    <div class="variant-name">2B: Subtracting (0-4), Result (5-9)</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="subtraction" data-variant="2C">
                    <div class="variant-name">2C: Subtracting (5-9), Result (0-4)</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="subtraction" data-variant="2D">
                    <div class="variant-name">2D: Subtracting (5-9), Result (5-9)</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="subtraction" data-variant="2">
                    <div class="variant-name">2: Subtracting Single-digit Numbers (0-9)</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="subtraction" data-variant="2M1">
                    <div class="variant-name">2M1: Subtracting Multi-digit Numbers without Borrow</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="subtraction" data-variant="2M2">
                    <div class="variant-name">2M2: Subtracting Multi-digit Numbers with Borrow</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="subtraction" data-variant="2M3">
                    <div class="variant-name">2M3: Subtracting Multi-digit Numbers with Borrow from 0</div>
                    <div class="variant-status">Not started</div>
                </div>
            </div>
            <div id="variantsContainerMultiplication" class="variants-container hidden">
                <div class="variant-card" data-operation="multiplication" data-variant="3A0">
                    <div class="variant-name">3A0: Multiplying 0 by any Number</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="multiplication" data-variant="3A1">
                    <div class="variant-name">3A1: Multiplying 1 by any Number</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="multiplication" data-variant="3A2S">
                    <div class="variant-name">3A2S: Table of 2</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="multiplication" data-variant="3A2">
                    <div class="variant-name">3A2: Table of 2 Random</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="multiplication" data-variant="3A3S">
                    <div class="variant-name">3A3S: Table of 3</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="multiplication" data-variant="3A3">
                    <div class="variant-name">3A3: Table of 3 Random</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="multiplication" data-variant="3A">
                    <div class="variant-name">3A: Multiplying 0, 1, 2, 3 by any Number</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="multiplication" data-variant="3B4S">
                    <div class="variant-name">3B4S: Table of 4</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="multiplication" data-variant="3B4">
                    <div class="variant-name">3B4: Table of 4 Random</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="multiplication" data-variant="3B5S">
                    <div class="variant-name">3B5S: Table of 5</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="multiplication" data-variant="3B5">
                    <div class="variant-name">3B5: Table of 5 Random</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="multiplication" data-variant="3B6S">
                    <div class="variant-name">3B6S: Table of 6</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="multiplication" data-variant="3B6">
                    <div class="variant-name">3B6: Table of 6 Random</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="multiplication" data-variant="3B">
                    <div class="variant-name">3B: Multiplying 4, 5, 6 by any Number</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="multiplication" data-variant="3C7S">
                    <div class="variant-name">3C7S: Table of 7</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="multiplication" data-variant="3C7">
                    <div class="variant-name">3C7: Table of 7 Random</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="multiplication" data-variant="3C8S">
                    <div class="variant-name">3C8S: Table of 8</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="multiplication" data-variant="3C8">
                    <div class="variant-name">3C8: Table of 8 Random</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="multiplication" data-variant="3C9S">
                    <div class="variant-name">3C9S: Table of 9</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="multiplication" data-variant="3C9">
                    <div class="variant-name">3C9: Table of 9 Random</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="multiplication" data-variant="3C">
                    <div class="variant-name">3C: Multiplying 7, 8, 9 by any Number</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="multiplication" data-variant="3">
                    <div class="variant-name">3: Multiplying Single-digit Numbers</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="multiplication" data-variant="3M1">
                    <div class="variant-name">3M1: Multi-digit x 1-digit Multiplication 1</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="multiplication" data-variant="3M2">
                    <div class="variant-name">3M2: Multi-digit x 1-digit Multiplication 2</div>
                    <div class="variant-status">Not started</div>
                </div>
            </div>
            <div id="variantsContainerDivision" class="variants-container hidden">
                <div class="variant-card" data-operation="division" data-variant="4A1">
                    <div class="variant-name">4A1: Dividing by 1</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="division" data-variant="4A2">
                    <div class="variant-name">4A2: Dividing by 2</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="division" data-variant="4A3">
                    <div class="variant-name">4A3: Dividing by 3</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="division" data-variant="4A">
                    <div class="variant-name">4A: Dividing by 1, 2, 3</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="division" data-variant="4B4">
                    <div class="variant-name">4B4: Dividing by 4</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="division" data-variant="4B5">
                    <div class="variant-name">4B5: Dividing by 5</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="division" data-variant="4B6">
                    <div class="variant-name">4B6: Dividing by 6</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="division" data-variant="4B">
                    <div class="variant-name">4B: Dividing by 4, 5, 6</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="division" data-variant="4C7">
                    <div class="variant-name">4C7: Dividing by 7</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="division" data-variant="4C8">
                    <div class="variant-name">4C8: Dividing by 8</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="division" data-variant="4C9">
                    <div class="variant-name">4C9: Dividing by 9</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="division" data-variant="4C">
                    <div class="variant-name">4C: Dividing by 7, 8, 9</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="division" data-variant="4">
                    <div class="variant-name">4: Dividing Single-digit Numbers (1-9)</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="division" data-variant="4M1">
                    <div class="variant-name">4M1: Multi-digit by 1-digit Division 1</div>
                    <div class="variant-status">Not started</div>
                </div>
                <div class="variant-card" data-operation="division" data-variant="4M2">
                    <div class="variant-name">4M2: Multi-digit by 1-digit Division 2</div>
                    <div class="variant-status">Not started</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize state
        let selectedOperation = null;
        
        const learningSequence = {
            addition: ['1A0', '1A1', '1A2', '1A3', '1A', '1B', '1C', '1D', '1', '1M1', '1M2'],
            subtraction: ['2A', '2B', '2C', '2D', '2', '2M1', '2M2', '2M3'],
            multiplication: ['3A0', '3A1', '3A2S', '3A2', '3A3S', '3A3', '3A', '3B4S', '3B4', '3B5S', '3B5', '3B6S', '3B6', '3B', '3C7S', '3C7', '3C8S', '3C8', '3C9S', '3C9', '3C', '3', '3M1', '3M2'],
            division: ['4A1', '4A2', '4A3', '4A', '4B4', '4B5', '4B6', '4B', '4C7', '4C8', '4C9', '4C', '4', '4M1', '4M2']
        };
        window.learningSequence = learningSequence;
        window.selectedOperation = selectedOperation;

        function updateStudentDashboardHeader() {
            if (currentUserProfile) {
                const fullName = [currentUserProfile.first_name, currentUserProfile.last_name].filter(Boolean).join(' ');
                const classSection = currentUserProfile.class && currentUserProfile.section 
                    ? `${currentUserProfile.class}${currentUserProfile.section}` 
                    : '';
                const rollNumber = currentUserProfile.roll_number || '';
                
                document.getElementById('userNameDisplay').textContent = fullName ? `Name: ${fullName}` : '';
                document.getElementById('userClassDisplay').textContent = classSection ? `Class: ${classSection}` : '';
                document.getElementById('userRollDisplay').textContent = rollNumber ? `Roll Number: ${rollNumber}` : '';
            }
        }


        // Override launchVariant to navigate to question page
        const originalLaunchVariant = window.launchVariant;
        window.launchVariant = function(operation, variant) {
            // Store operation and variant in sessionStorage
            sessionStorage.setItem('quizOperation', operation);
            sessionStorage.setItem('quizVariant', variant);
            // Navigate to question page
            window.location.href = 'question.html';
        };

        window.addEventListener('DOMContentLoaded', () => {
            // Don't set selectedOperation here - let fetchAndUpdateVariantStatuses() determine it
            // based on first incomplete operation, or 'addition' if all are complete
            
            // Initialize Supabase
            function tryInitSupabase(attempts = 0) {
                if (window.supabase && window.supabase.createClient) {
                    initSupabase();
                } else if (attempts < 5) {
                    setTimeout(() => tryInitSupabase(attempts + 1), 1000);
                } else {
                    console.error('❌ Supabase library failed to load');
                }
            }
            
            tryInitSupabase();

            // Fallback: If updateAuthUI() hasn't loaded variants after 3 seconds, fetch them directly
            // This ensures variants always load even if updateAuthUI() is delayed or fails
            setTimeout(() => {
                const additionContainer = document.getElementById('variantsContainerAddition');
                const isLoading = additionContainer && (
                    additionContainer.innerHTML.trim() === '' ||
                    additionContainer.classList.contains('hidden')
                );
                
                // If still loading or empty, fetch variant statuses directly
                if (isLoading && typeof fetchAndUpdateVariantStatuses === 'function') {
                    console.log('⏳ Fallback: Fetching variant statuses directly (updateAuthUI may not have completed)');
                    fetchAndUpdateVariantStatuses();
                }
            }, 3000);
        });
    </script>
</body>
</html>
